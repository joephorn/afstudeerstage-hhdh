<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>p5 export poc</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
  <script src="https://unpkg.com/p5.js-svg@1.6.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.2/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/svg2pdf.js@2.2.4/dist/svg2pdf.umd.min.js"></script>
  <script type="module" src="./sketch.js"></script>
  <style>button{margin-right:8px;margin-top:8px}</style>
</head>
<body>
  <button onclick="save('sketch.svg')">Export SVG</button>
  <button onclick="exportPDF()">Export PDF (vector)</button>
  <button onclick="exportPNG()">Export PNG</button>
  <button onclick="exportWebM()">Export WebM</button>
  <button onclick="exportHTML({ filename: 'sketch.html', title: 'pagina naam' })">Export HTML</button>
  <button onclick="exportLottie()">Export Lottie</button>

  <script>
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: "portrait",
        unit: "pt",
        format: [width, height],
      });
      // Try multiple attachment patterns for svg2pdf
      const pickFn = (...cands) => cands.find(fn => typeof fn === "function") || null;
      const svg2pdfFn = pickFn(
        window.svg2pdf,
        window.svg2pdf && window.svg2pdf.default,
        window.svg2pdf && window.svg2pdf.svg2pdf,
        window.svg2pdf && window.svg2pdf.default && window.svg2pdf.default.svg2pdf,
        (typeof svg2pdf !== "undefined" ? svg2pdf : null),
        (typeof svg2pdf !== "undefined" && svg2pdf.default ? svg2pdf.default : null),
        (typeof svg2pdf !== "undefined" && svg2pdf.svg2pdf ? svg2pdf.svg2pdf : null)
      );
      if (!svg2pdfFn) {
        alert("svg2pdf library not loaded (or wrong build). Check <script> includes.");
        return;
      }
      const svg = document.querySelector("svg");
      await svg2pdfFn(svg, pdf, {
        x: 0,
        y: 0,
        width: width,
        height: height,
        useCSS: true,
      });
      pdf.save("sketch.pdf");
    }

    async function exportPNG({filename='sketch.png', scale=5, background=null}={}) {
      const svg = document.querySelector('svg');
      const clone = svg.cloneNode(true);
      if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
      const vb = clone.viewBox.baseVal;
      const w = Math.round((vb.width  || 800) * scale);
      const h = Math.round((vb.height || 600) * scale);

      const data = new XMLSerializer().serializeToString(clone);
      const url  = URL.createObjectURL(new Blob([data], {type:'image/svg+xml'}));

      const img = new Image();
      await new Promise((res, rej) => { img.onload=res; img.onerror=rej; img.src=url; });

      const c = document.createElement('canvas'); c.width=w; c.height=h;
      const ctx = c.getContext('2d');
      if (background) { ctx.fillStyle = background; ctx.fillRect(0,0,w,h); }
      ctx.drawImage(img, 0, 0, w, h);
      URL.revokeObjectURL(url);

      c.toBlob(b => { const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=filename; a.click(); }, 'image/png');
    }

    async function exportMP4() {
      
    }

    async function exportWebM({ fps = 60, seconds = 4, filename = 'sketch.webm', bitrateMbps = 8 } = {}) {
      // Zet sketch in 'recording' modus (tekent mee naar bitmap alleen tijdens opname)
      if (typeof window.__startRecording === 'function') window.__startRecording();
    
      // Gebruik het bitmap-canvas dat je in sketch.js expose't (NIET het SVG-canvas)
      const canvas = (typeof window.captureCanvas !== 'undefined' && window.captureCanvas)
        ? window.captureCanvas
        : (typeof window.getRecCanvas === 'function' ? window.getRecCanvas() : null);
      if (!canvas) {
        alert('Recorder canvas not found. Zorg dat sketch.js window.captureCanvas of window.getRecCanvas() zet.');
        if (typeof window.__stopRecording === 'function') window.__stopRecording();
        return;
      }
    
      // Start de recorder
      const stream = canvas.captureStream(fps);
      const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp9')
        ? 'video/webm;codecs=vp9'
        : (MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/webm');
      const recorder = new MediaRecorder(stream, { mimeType: mime, videoBitsPerSecond: bitrateMbps * 1_000_000 });
    
      const chunks = [];
      recorder.ondataavailable = e => e.data && e.data.size && chunks.push(e.data);
      recorder.onstop = () => {
        // Recording modus uitzetten
        if (typeof window.__stopRecording === 'function') window.__stopRecording();
        const blob = new Blob(chunks, { type: mime });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      };
    
      recorder.start();
    
      // Drive frames deterministisch: roep p5's draw() aan met redraw() op exact FPS
      const total = Math.max(1, Math.round(fps * seconds));
      let i = 0;
      const handle = setInterval(() => {
        if (typeof window.redraw === 'function') window.redraw(); // triggert draw()
        i++;
        if (i >= total) {
          clearInterval(handle);
          recorder.stop();
        }
      }, 1000 / fps);
    }

    function exportHTML({ filename = 'sketch.html', title = 'Sketch Export' } = {}) {
      const svg = document.querySelector('svg');
      if (!svg) { console.error('SVG not ready'); return; }

      // Clone met namespaces
      const clone = svg.cloneNode(true);
      if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
      if (!clone.getAttribute('xmlns:xlink')) clone.setAttribute('xmlns:xlink','http://www.w3.org/1999/xlink');

      // Maak een nieuw HTML-document in memory
      const doc = document.implementation.createHTMLDocument(title);

      // Style
      const style = doc.createElement('style');
      style.textContent = `
        html,body { margin:0; padding:0; background:#f0f0f0; }
        .wrap { display:grid; place-items:center; min-height:100vh; }
        svg { max-width:100vw; height:auto; display:block; background:white; }
      `;
      doc.head.appendChild(style);

      // Content
      const wrap = doc.createElement('div');
      wrap.className = 'wrap';
      wrap.appendChild(doc.importNode(clone, true));
      doc.body.appendChild(wrap);

      // Serialize + download
      const htmlString = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
      const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
      const a = document.createElement('a');
      a.download = filename.endsWith('.html') ? filename : `${filename}.html`;
      a.href = URL.createObjectURL(blob);
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function exportLottie() {
        
    }
  </script>
</body>
</html>